<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Form3 – Descriptive Analytics & Word Report Generation</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <header>
        <h1>Stage 4 – Form3: Descriptive Analytics and Word Report Generation</h1>
        <p>
            Form3 bridges diagnostic analytics with a polished, descriptive report. It runs various SQL queries to summarize your expense data and compiles those results into a styled Word document report using the OpenXML SDK.
        </p>
    </header>

    <main>

        <!-- Section 1: Overview -->
        <section>
            <h2>Overview of Form3</h2>
            <p>
                Form3 executes several queries to derive descriptive insights (e.g., total spending, top category, monthly trends, average spend,
                largest expense, etc.). The data is then displayed on the form via labels (and, when needed, a DataGridView) and can be exported to
                a Word report for final presentation. Below you’ll find a detailed breakdown of each event handler and helper function.
            </p>
        </section>
        <section>
            <h2>Initial Imports and Form Setup</h2>
            <p>
                Before implementing the detailed functionality of Form3, ensure you include these essential import statements and the basic form declaration.
                These imports load the necessary libraries (such as OpenXML for Word report generation and SqlClient for database operations) and set up
                the foundation for your form.
            </p>
            <pre><code>
Imports DocumentFormat.OpenXml
Imports DocumentFormat.OpenXml.Packaging
Imports DocumentFormat.OpenXml.Wordprocessing
Imports Microsoft.Data.SqlClient
Imports System.Text

Public Class Form3
    ' Your Form3 code begins here...
End Class
  </code></pre>
            <p>
                Place this block at the very top of your Form3.vb file. It guarantees that all required libraries are available and sets up the proper structure
                for your descriptive analytics and report generation code.
            </p>
        </section>

        <!-- Section 2: SQL Query Execution & Result Display -->
        <section>
            <h2>SQL Query Execution and Result Display</h2>

            <!-- Query 1 -->
            <h3>1. Total Spending (ButtonRunQuery1)</h3>
            <pre><code>
Private Sub ButtonRunQuery1_Click(sender As Object, e As EventArgs) Handles ButtonRunQuery1.Click
    Dim query = "SELECT SUM(AmountSpent) AS TotalAmountSpent FROM Expenses"
    Dim connStr As String = My.Settings.DbConnectionString

    Try
        Using conn As New SqlConnection(connStr)
            conn.Open()
            Using cmd As New SqlCommand(query, conn)
                Dim result = cmd.ExecuteScalar()
                Dim total As Decimal = If(IsDBNull(result), 0D, Convert.ToDecimal(result))
                LabelQuery1.Text = $"🔹 Total spending to date: {total:C}"
            End Using
        End Using
    Catch ex As Exception
        MessageBox.Show("Failed to retrieve total: " & ex.Message)
        LabelQuery1.Text = "Error retrieving total."
    End Try
End Sub
    </code></pre>
            <p>
                <strong>Explanation:</strong> This event handler runs a scalar query to sum the Total AmountSpent from the Expenses table and shows
                the result (formatted as currency) in LabelQuery1.
            </p>

            <!-- Query 2 -->
            <h3>2. Highest Spending Category (ButtonRunQuery2)</h3>
            <pre><code>
Private Sub ButtonRunQuery2_Click(sender As Object, e As EventArgs) Handles ButtonRunQuery2.Click
    Dim query = "
        SELECT TOP 1 Category, SUM(AmountSpent) AS TotalSpent
        FROM Expenses
        GROUP BY Category
        ORDER BY TotalSpent DESC"
    Dim connStr As String = My.Settings.DbConnectionString

    Try
        Using conn As New SqlConnection(connStr)
            conn.Open()
            Using cmd As New SqlCommand(query, conn)
                Using reader = cmd.ExecuteReader()
                    If reader.Read() Then
                        Dim category As String = reader("Category").ToString()
                        Dim total As Decimal = Convert.ToDecimal(reader("TotalSpent"))
                        LabelQuery2.Text = $"📌 Highest spending category: {category} — {total:C}"
                    Else
                        LabelQuery2.Text = "No spending data found."
                    End If
                End Using
            End Using
        End Using
    Catch ex As Exception
        MessageBox.Show("Error fetching top category: " & ex.Message)
        LabelQuery2.Text = "Query error."
    End Try
End Sub
    </code></pre>
            <p>
                <strong>Explanation:</strong> Here, a query groups expenses by Category and selects the one with the highest total spending.
                The result is displayed in LabelQuery2.
            </p>

            <!-- Query 3 -->
            <h3>3. Most Recent Month Spending (ButtonRunQuery3)</h3>
            <pre><code>
Private Sub ButtonRunQuery3_Click(sender As Object, e As EventArgs) Handles ButtonRunQuery3.Click
    LabelQuery3.Text = ""
    Dim query = "
        SELECT TOP 1 FORMAT(DateSpent, 'MMM yyyy') AS [Month], SUM(AmountSpent) AS Total
        FROM Expenses
        GROUP BY FORMAT(DateSpent, 'MMM yyyy')
        ORDER BY MIN(DateSpent) DESC"
    Dim connStr As String = My.Settings.DbConnectionString

    Try
        Using conn As New SqlConnection(connStr)
            conn.Open()
            Using cmd As New SqlCommand(query, conn)
                Using reader = cmd.ExecuteReader()
                    If reader.Read() Then
                        Dim [month] As String = reader("Month").ToString()
                        Dim total As Decimal = Convert.ToDecimal(reader("Total"))
                        LabelQuery3.Text = $"📅 Most recent month: {[month]} — {total:C} spent"
                    Else
                        LabelQuery3.Text = "No data available for monthly trends."
                    End If
                End Using
            End Using
        End Using
    Catch ex As Exception
        LabelQuery3.Text = "Error fetching monthly trend."
    End Try
End Sub
    </code></pre>
            <p>
                <strong>Explanation:</strong> This query formats the expense dates to "MMM yyyy" and groups them. It then pulls the most recent
                month’s spending and displays the summary in LabelQuery3.
            </p>

            <!-- Query 4 -->
            <h3>4. Average Daily Spend (ButtonRunQuery4)</h3>
            <pre><code>
Private Sub ButtonRunQuery4_Click(sender As Object, e As EventArgs) Handles ButtonRunQuery4.Click
    LabelQuery4.Text = ""
    Dim query = "
        SELECT SUM(AmountSpent) / COUNT(DISTINCT CAST(DateSpent AS DATE)) AS AvgDaily
        FROM Expenses"
    Dim connStr As String = My.Settings.DbConnectionString

    Try
        Using conn As New SqlConnection(connStr)
            conn.Open()
            Using cmd As New SqlCommand(query, conn)
                Dim result = cmd.ExecuteScalar()
                Dim avg As Decimal = If(IsDBNull(result), 0D, Convert.ToDecimal(result))
                LabelQuery4.Text = $"📈 Average daily spend: {avg:C}"
            End Using
        End Using
    Catch ex As Exception
        LabelQuery4.Text = "Error calculating daily average."
    End Try
End Sub
    </code></pre>
            <p>
                <strong>Explanation:</strong> This handler calculates the average daily expenditure by dividing the total spending by the number
                of unique days. The result is formatted and shown in LabelQuery4.
            </p>

            <!-- Query 5 -->
            <h3>5. Most Used Payment Method (ButtonRunQuery5)</h3>
            <pre><code>
Private Sub ButtonRunQuery5_Click(sender As Object, e As EventArgs) Handles ButtonRunQuery5.Click
    LabelQuery5.Text = ""
    Dim query = "
     SELECT TOP 1 PaymentMethod, COUNT(*) AS Uses
     FROM Expenses
     GROUP BY PaymentMethod
     ORDER BY Uses DESC"
    Dim connStr As String = My.Settings.DbConnectionString

    Try
        Using conn As New SqlConnection(connStr)
            conn.Open()
            Using cmd As New SqlCommand(query, conn)
                Using reader = cmd.ExecuteReader()
                    If reader.Read() Then
                        Dim method As String = reader("PaymentMethod").ToString()
                        Dim uses As Integer = Convert.ToInt32(reader("Uses"))
                        LabelQuery5.Text = $"💳 Most used payment method: {method} ({uses} times)"
                    Else
                        LabelQuery5.Text = "No payment method data found."
                    End If
                End Using
            End Using
        End Using
    Catch ex As Exception
        LabelQuery5.Text = "Error retrieving payment method frequency."
    End Try
End Sub
    </code></pre>
            <p>
                <strong>Explanation:</strong> This query identifies which payment method (e.g., card or cash) is used most often by counting occurrences.
                The result is then reflected in LabelQuery5.
            </p>

            <!-- Query 6 -->
            <h3>6. Largest Single Expense (ButtonRunQuery6)</h3>
            <pre><code>
Private Sub ButtonRunQuery6_Click(sender As Object, e As EventArgs) Handles ButtonRunQuery6.Click
    LabelQuery6.Text = ""
    Dim query = "
     SELECT MAX(AmountSpent) AS MaxSpent
     FROM Expenses"
    Dim connStr As String = My.Settings.DbConnectionString

    Try
        Using conn As New SqlConnection(connStr)
            conn.Open()
            Using cmd As New SqlCommand(query, conn)
                Dim result = cmd.ExecuteScalar()
                Dim maxSpent As Decimal = If(IsDBNull(result), 0D, Convert.ToDecimal(result))
                LabelQuery6.Text = $"🧨 Largest single expense: {maxSpent:C}"
            End Using
        End Using
    Catch ex As Exception
        LabelQuery6.Text = "Error retrieving highest transaction."
    End Try
End Sub
    </code></pre>
            <p>
                <strong>Explanation:</strong> This simple scalar query returns the maximum expense recorded and displays it in LabelQuery6.
            </p>

            <!-- Query 7: Custom Date Range -->
            <h3>7. Custom Date Range Spending (ButtonCalculation)</h3>
            <pre><code>
Private Sub ButtonCalculation_Click(sender As Object, e As EventArgs) Handles ButtonCalculation.Click
    LabelCalculationResult.Text = ""
    Dim fromDate As Date = DateTimePickerFrom.Value.Date
    Dim toDate As Date = DateTimePickerTo.Value.Date

    If fromDate > toDate Then
        MessageBox.Show("The 'From' date must be earlier than the 'To' date.", "Invalid Date Range", <br />MessageBoxButtons.OK, MessageBoxIcon.Warning)
        Return
    End If

    Dim query = "
     SELECT SUM(AmountSpent) AS Total
     FROM Expenses
     WHERE DateSpent BETWEEN @FromDate AND @ToDate"
    Dim connStr As String = My.Settings.DbConnectionString

    Try
        Using conn As New SqlConnection(connStr)
            conn.Open()
            Using cmd As New SqlCommand(query, conn)
                cmd.Parameters.AddWithValue("@FromDate", fromDate)
                cmd.Parameters.AddWithValue("@ToDate", toDate)
                Dim result = cmd.ExecuteScalar()
                If result IsNot Nothing AndAlso Not IsDBNull(result) Then
                    Dim total As Decimal = Convert.ToDecimal(result)
                    LabelCalculationResult.Text = $"🗓️ From {fromDate:dd MMM yyyy} to {toDate:dd MMM yyyy}, <br />you spent {total:C}."
                Else
                    LabelCalculationResult.Text = $"📭 No expenses found between {fromDate:dd MMM yyyy} and <br />{toDate:dd MMM yyyy}."
                End If
            End Using
        End Using
    Catch ex As Exception
        LabelCalculationResult.Text = "An error occurred during calculation."
        MessageBox.Show("Calculation error: " & ex.Message)
    End Try
End Sub
    </code></pre>
            <p>
                <strong>Explanation:</strong> Using a parameterized query, this code sums the spending within a user-defined date range and displays a detailed message on the form.
            </p>
        </section>

        <!-- Section 3: Inventory & Favorite Place -->
        <section>
            <h2>Inventory and Favorite Spending Place</h2>

            <h3>Inventory Overview (ButtonInventory)</h3>
            <pre><code>
Private Sub ButtonInventory_Click(sender As Object, e As EventArgs) Handles ButtonInventory.Click
    dgvInventory.DataSource = Nothing
    dgvInventory.Rows.Clear()
    dgvInventory.Columns.Clear()
    LabelInventory.Text = ""

    Dim query = "
     SELECT DateSpent, SpentOn, AmountSpent
     FROM Expenses
     ORDER BY DateSpent ASC"
    Dim connStr As String = My.Settings.DbConnectionString
    Dim dt As New DataTable()
    Dim totalValue As Decimal = 0D

    Try
        Using conn As New SqlConnection(connStr)
            conn.Open()
            Using da As New SqlDataAdapter(query, conn)
                da.Fill(dt)
            End Using
        End Using

        If dt.Rows.Count = 0 Then
            LabelInventory.Text = "📭 No inventory records found yet."
            Return
        End If

        ' Calculate total inventory value
        For Each row As DataRow In dt.Rows
            If Not IsDBNull(row("AmountSpent")) Then
                totalValue += Convert.ToDecimal(row("AmountSpent"))
            End If
        Next

        ' Bind to DataGridView
        dgvInventory.DataSource = dt
        dgvInventory.Columns("AmountSpent").DefaultCellStyle.Format = "C"
        dgvInventory.Columns("DateSpent").DefaultCellStyle.Format = "dd MMM yyyy"

        LabelInventory.Text = $"📦 Hey! So far, your personal inventory is worth {totalValue:C} based on <br />total purchases."

    Catch ex As Exception
        LabelInventory.Text = "❌ Something went wrong while loading your inventory."
        MessageBox.Show("Error loading inventory: " & ex.Message, "Inventory Error", MessageBoxButtons.OK,<br /> MessageBoxIcon.Error)
    End Try
End Sub
    </code></pre>
            <p>
                <strong>Explanation:</strong> The handler retrieves a list of expenses, calculates the cumulative total, binds the results to a DataGridView with proper formatting, and displays a summary.
            </p>

            <h3>Favorite Spending Place (ButtonPlace)</h3>
            <pre><code>
Private Sub ButtonPlace_Click(sender As Object, e As EventArgs) Handles ButtonPlace.Click
    LabelPlace.Text = ""
    Dim query = "
     SELECT TOP 1 PlaceSpent, COUNT(*) AS VisitCount
     FROM Expenses
     WHERE PlaceSpent IS NOT NULL AND PlaceSpent <> ''
     GROUP BY PlaceSpent
     ORDER BY VisitCount DESC"
    Dim connStr As String = My.Settings.DbConnectionString

    Try
        Using conn As New SqlConnection(connStr)
            conn.Open()
            Using cmd As New SqlCommand(query, conn)
                Using reader = cmd.ExecuteReader()
                    If reader.Read() Then
                        Dim favPlace As String = reader("PlaceSpent").ToString()
                        Dim visits As Integer = Convert.ToInt32(reader("VisitCount"))
                        LabelPlace.Text = $"📍 Hey! To date, your favorite place to spend is **{favPlace}**, <br />visited {visits} times."
                    Else
                        LabelPlace.Text = "🗺️ You haven’t recorded any places yet—but we’ll spot your favorite<br /> once you do!"
                    End If
                End Using
            End Using
        End Using
    Catch ex As Exception
        LabelPlace.Text = "❌ Couldn’t fetch favorite place. Please try again."
        MessageBox.Show("Place query error: " & ex.Message)
    End Try
End Sub
    </code></pre>
            <p>
                <strong>Explanation:</strong> This query groups spending locations, selects the top one by frequency, and displays it as your favorite spending destination.
            </p>
        </section>

        <!-- Section 4: Report Generation & Helper Functions -->
        <section>
            <h2>Report Generation with Word (ButtonSave) and Helper Functions</h2>

            <h3>Export Report (ButtonSave_Click)</h3>
            <pre><code>
Private Sub ButtonSave_Click(sender As Object, e As EventArgs) Handles ButtonSave.Click
    Dim saveDialog As New SaveFileDialog() With {
        .Filter = "Word Document (*.docx)|*.docx",
        .FileName = $"ExpenseReport_{DateTime.Now:yyyyMMdd_HHmmss}.docx",
        .Title = "Save Expense Report"
    }
    If saveDialog.ShowDialog() <> DialogResult.OK Then Exit Sub
    Dim fullPath As String = saveDialog.FileName
    Using doc As WordprocessingDocument = WordprocessingDocument.Create(fullPath, <br />WordprocessingDocumentType.Document)
        Dim mainPart = doc.AddMainDocumentPart()
        mainPart.Document = New Document(New Body())
        Dim body = mainPart.Document.Body

        ' Title and timestamp
        body.Append(CreateParagraph("Comprehensive Expense Report", True, "Center", "28", "Segoe UI"))
        body.Append(CreateParagraph("Generated on: " & DateTime.Now.ToString("F"), False, "Center", "20",<br /> "Segoe UI"))
        body.Append(CreateParagraph(" ", False)) ' spacer

        ' Section 1: Expense Overview
        body.Append(CreateParagraph("Expense Overview", True, "Left", "24", "Segoe UI"))
        body.Append(CreateParagraph(LabelQuery1.Text, False, "Left", "20", "Segoe UI"))
        body.Append(CreateParagraph(LabelQuery2.Text, False, "Left", "20", "Segoe UI"))
        body.Append(CreateParagraph(LabelQuery3.Text, False, "Left", "20", "Segoe UI"))
        body.Append(CreateParagraph(LabelQuery4.Text, False, "Left", "20", "Segoe UI"))
        body.Append(CreateParagraph(LabelQuery5.Text, False, "Left", "20", "Segoe UI"))
        body.Append(CreateParagraph(LabelQuery6.Text, False, "Left", "20", "Segoe UI"))
        body.Append(CreateParagraph(" ", False)) ' spacer

        ' Section 2: Custom Date Range Spending
        body.Append(CreateParagraph("Custom Date Range Spending", True, "Left", "24", "Segoe UI"))
        body.Append(CreateParagraph(LabelCalculationResult.Text, False, "Left", "20", "Segoe UI"))
        body.Append(CreateParagraph(" ", False)) ' spacer

        ' Section 3: Inventory Overview
        body.Append(CreateParagraph("Inventory Overview", True, "Left", "24", "Segoe UI"))
        body.Append(CreateParagraph(LabelInventory.Text, False, "Left", "20", "Segoe UI"))
        ' Optionally include detailed Inventory records in a table:
        Dim dtInv As New DataTable()
        Dim queryInv As String = "SELECT DateSpent, SpentOn, AmountSpent FROM Expenses ORDER BY DateSpent ASC"
        Dim connStr As String = My.Settings.DbConnectionString
        Try
            Using conn As New SqlConnection(connStr)
                conn.Open()
                Using da As New SqlDataAdapter(queryInv, conn)
                    da.Fill(dtInv)
                End Using
            End Using
            If dtInv.Rows.Count > 0 Then
                body.Append(CreateParagraph("Detailed Inventory Records", True, "Left", "24", "Segoe UI"))
                Dim table As Table = CreateTableFromDataTable(dtInv)
                body.Append(table)
            End If
        Catch ex As Exception
            body.Append(CreateParagraph("Error loading detailed inventory records.", False, "Left", "20", <br />"Segoe UI"))
        End Try
        body.Append(CreateParagraph(" ", False)) ' spacer

        ' Section 4: Favorite Spending Place
        body.Append(CreateParagraph("Favorite Spending Place", True, "Left", "24", "Segoe UI"))
        body.Append(CreateParagraph(LabelPlace.Text, False, "Left", "20", "Segoe UI"))
        body.Append(CreateParagraph(" ", False)) ' spacer

        ' Footer
        body.Append(CreateParagraph("Generated by Syntax Analytics Academy", False, "Right", "16", "Segoe UI"))
        mainPart.Document.Save()
    End Using
    MessageBox.Show("Report saved successfully at " & fullPath, "Export Complete", MessageBoxButtons.OK,<br /> MessageBoxIcon.Information)
End Sub
    </code></pre>
            <p>
                <strong>Explanation:</strong> This event handler creates a new Word document using the OpenXML SDK. It builds the report
                by appending styled paragraphs for each section of the report and even includes a table of detailed inventory records if available.
            </p>

            <h3>Helper Function: CreateParagraph</h3>
            <pre><code>
Private Function CreateParagraph(text As String, isBold As Boolean, Optional justification As String =<br /> "Left", Optional fontSize As String = "20", Optional fontName As String = "Segoe UI") As Paragraph
    Dim p As New Paragraph()
    Dim run As New Run()
    Dim runProps As New RunProperties()
    If isBold Then
        runProps.Append(New Bold())
    End If
    runProps.Append(New RunFonts() With {.Ascii = fontName, .HighAnsi = fontName})
    runProps.Append(New FontSize() With {.Val = fontSize})
    run.Append(runProps)
    run.Append(New Text(text) With {.Space = SpaceProcessingModeValues.Preserve})
    Dim pPr As New ParagraphProperties()
    Select Case justification.ToLower()
        Case "center"
            pPr.Append(New Justification() With {.Val = JustificationValues.Center})
        Case "right"
            pPr.Append(New Justification() With {.Val = JustificationValues.Right})
        Case Else
            pPr.Append(New Justification() With {.Val = JustificationValues.Left})
    End Select
    p.PrependChild(pPr)
    p.Append(run)
    Return p
End Function
    </code></pre>
            <p>
                <strong>Explanation:</strong> This helper function creates a paragraph with customizable text, font size, boldness,
                and justification. It makes the DOCX report's layout consistent and visually appealing.
            </p>

            <h3>Helper Function: CreateTableFromDataTable</h3>
            <pre><code>
Private Function CreateTableFromDataTable(dt As DataTable) As Table
    Dim table As New Table()
    Dim tblProps As New TableProperties(
        New TableBorders(
            New TopBorder() With {.Val = BorderValues.Single, .Size = 6},
            New BottomBorder() With {.Val = BorderValues.Single, .Size = 6},
            New LeftBorder() With {.Val = BorderValues.Single, .Size = 6},
            New RightBorder() With {.Val = BorderValues.Single, .Size = 6},
            New InsideHorizontalBorder() With {.Val = BorderValues.Single, .Size = 6},
            New InsideVerticalBorder() With {.Val = BorderValues.Single, .Size = 6}
        )
    )
    table.AppendChild(tblProps)
    Dim headerRow As New TableRow()
    For Each col As DataColumn In dt.Columns
        Dim cell As New TableCell()
        cell.Append(New Paragraph(New Run(New Text(col.ColumnName))))
        headerRow.Append(cell)
    Next
    table.Append(headerRow)
    For Each dr As DataRow In dt.Rows
        Dim row As New TableRow()
        For Each col As DataColumn In dt.Columns
            Dim cell As New TableCell()
            Dim cellText As String = ""
            If Not IsDBNull(dr(col)) Then
                If TypeOf dr(col) Is Date Then
                    cellText = Convert.ToDateTime(dr(col)).ToString("dd MMM yyyy")
                ElseIf TypeOf dr(col) Is Decimal OrElse TypeOf dr(col) Is Double Then
                    cellText = Convert.ToDecimal(dr(col)).ToString("C")
                Else
                    cellText = dr(col).ToString()
                End If
            End If
            cell.Append(New Paragraph(New Run(New Text(cellText))))
            row.Append(cell)
        Next
        table.Append(row)
    Next
    Return table
End Function
    </code></pre>
            <p>
                <strong>Explanation:</strong> This function converts a DataTable into an OpenXML Table, complete with borders. It creates a header
                row using column names and populates subsequent rows with properly formatted data.
            </p>
        </section>

        <!-- Section 5: Summary -->
        <section>
            <h2>Summary of Form3</h2>
            <ul>
                <li><strong>Query Execution:</strong> Retrieves descriptive analytics (totals, averages, maximums, most frequent items, etc.).</li>
                <li><strong>Data Display:</strong> Presents insights via labels and a DataGridView.</li>
                <li><strong>Report Generation:</strong> Combines these results into a formatted Word report using OpenXML.</li>
                <li><strong>Helper Functions:</strong> Ensure consistent styling of paragraphs and tables for a professional document look.</li>
            </ul>
            <p>
                Form3 is the capstone of your analytical journey—transforming raw data into an articulate, shareable report.
            </p>
        </section>

    </main>

    <footer>
        <p>SQL Craft Academy &copy; 2025 | Learning Beyond Limits</p>
    </footer>

</body>
</html>